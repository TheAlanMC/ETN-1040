<p-toast></p-toast>

<p-sidebar #sidebar (onHide)="onClose()" (onShow)="onSidebarShow()" [(visible)]="sidebarVisible" [baseZIndex]="10000"
           [showCloseIcon]="false" position="right" styleClass="w-full md:w-8 lg:w-6 xl:w-5">
    <p-confirmDialog [appendTo]="sidebar" [baseZIndex]="10000" [style]="{width: '350px'}"
                     acceptButtonStyleClass="p-button-primary"
                     header="Confirmation"
                     icon="pi pi-exclamation-triangle"
                     key="confirmStatusChange"
                     message="'¿Estás seguro de que deseas cambiar el estado de la tarea a ${taskStatus.label}?'"
                     rejectButtonStyleClass="p-button-text"></p-confirmDialog>
    <p-confirmDialog [appendTo]="sidebar" [baseZIndex]="10000" [style]="{width: '350px'}"
                     acceptButtonStyleClass="p-button-primary"
                     header="Confirmation"
                     icon="pi pi-exclamation-triangle"
                     key="confirmDeleteComment"
                     message="'¿Estás seguro de que deseas eliminar esta comentario? Esta acción no se puede deshacer.'"
                     rejectButtonStyleClass="p-button-text"></p-confirmDialog>
    <p-confirmDialog [appendTo]="sidebar" [baseZIndex]="10000" [style]="{width: '350px'}"
                     acceptButtonStyleClass="p-button-primary"
                     header="Confirmation"
                     icon="pi pi-exclamation-triangle"
                     key="confirmDeleteReplacement"
                     message="'¿Estás seguro de que deseas eliminar este reemplazo? Esta acción no se puede deshacer.'"
                     rejectButtonStyleClass="p-button-text"></p-confirmDialog>

    <ng-template pTemplate="header">
        <div class="flex pl-3 pr-2 surface-border border-bottom-1 justify-content-between align-items-center w-full">
            <span class="block text-900 font-bold text-xl">Ver Tarea</span>
            <button (click)="onClose()" class="p-button-rounded p-button-text p-button-secondary" icon="pi pi-times"
                    pButton
                    pRipple
                    type="button"></button>
        </div>
    </ng-template>
    <ng-template pTemplate="content">
        <div *ngIf="task">
            <div class="grid p-fluid formgrid px-3">
                <div class="col-12 field">
                    <label class="font-semibold text-900" for="title">Título de la Tarea</label>
                    <input [(ngModel)]="taskName" [readonly]="true" class="w-full" id="title" name="title"
                           pInputText
                           placeholder="Título de la tarea" type="text">
                </div>
                <div class="col-12 field">
                    <label class="font-semibold text-900" for="description">Descripción de la Tarea</label>
                    <textarea [(ngModel)]="taskDescription" [readonly]="true" [rows]="3" class="w-full"
                              id="description"
                              name="description"
                              pInputTextarea placeholder="Description de la tarea"
                              style="resize: none" type="text"></textarea>
                </div>
                <div class="col-12 lg:col-6 field">
                    <label class="font-semibold text-900" for="deadline">Fecha Límite</label>
                    <p-calendar [(ngModel)]="taskDueDate" [appendTo]="sidebar" [disabled]="true"
                                [minDate]="today"
                                [readonlyInput]="true" [showIcon]="true"
                                [showSeconds]="false" [showTime]="true" dateFormat="dd/mm/yy" id="deadline"
                                placeholder="Fecha límite"></p-calendar>
                </div>
                <div class="col-12 lg:col-6 field">
                    <label class="font-semibold text-900" for="priority">Prioridad</label>
                    <p-dropdown [(ngModel)]="selectedPriority" [appendTo]="sidebar" [disabled]="!task" [filter]="false"
                                [options]="priorityItems" [readonly]="true"
                                id=priority placeholder="Seleccionar prioridad"></p-dropdown>
                </div>
                <div class="col-12 field">
                    <div class="border-1 surface-border border-round field">
                        <span class="font-semibold text-900 block border-bottom-1 surface-border p-3">Responsables</span>
                        <div class="p-3">
                            <div *ngIf="selectedAssignees.length > 0" class="auto-flex align-items-center field">
                                <p-chips [(ngModel)]="selectedAssignees" [disabled]="true" class="chips-custom">
                                    <ng-template let-item pTemplate="item">
                                        <img
                                                (error)="imgLoaded[item.value] = false"
                                                (load)="imgLoaded[item.value] = true"
                                                [src]="imgLoaded[item.value] ? (baseUrl + '/' + item.value + '/profile-picture/thumbnail') : 'assets/layout/images/avatar_thumbnail.png'"
                                                alt="{{item.value}}"
                                                class="mr-1"
                                                style="width: 25px; height: 25px; border-radius: 50%; object-fit: cover;">
                                        <span class="ml-1">{{ item.label }}</span>
                                    </ng-template>
                                </p-chips>
                            </div>
                        </div>
                    </div>
                </div>
                <div *ngIf="task?.taskFiles!.length > 0" class="col-12 field">
                    <div class="border-1 surface-border border-round field">
                        <span class="font-semibold text-900 block border-bottom-1 surface-border p-3">Archivos Adjuntos
                                                <span class="text-900 font-semibold"><i
                                                        class="pi pi-paperclip text-700 mx-2"></i>{{ task!.taskFiles!.length }}</span>
                        </span>
                        <p-fileUpload #fileUploader [auto]="true"
                                      [customUpload]="true"
                                      [disabled]="true" [multiple]="true" [showCancelButton]="false"
                                      [showUploadButton]="false" maxFileSize="10000000"
                                      styleClass="border-1 surface-border surface-card border-round">
                            <ng-template pTemplate="content">
                                <div (click)="fileUploader.advancedFileInput.nativeElement.click()"
                                     class="h-10rem overflow-y-auto border-round"
                                >
                                    <div *ngIf="!task?.taskFiles?.length"
                                         class="flex flex-column w-full h-full justify-content-center align-items-center">
                                        <i class="pi pi-file-excel text-900 text-4xl"></i>
                                        <span class="block font-semibold text-900 text-lg mt-3">No hay archivos adjuntos</span>
                                    </div>
                                    <div *ngIf="task?.taskFiles?.length" class="flex flex-wrap border-round">
                                        <div (mouseenter)="onFileMouseOver(file)"
                                             (mouseleave)="onFileMouseLeave(file)"
                                             *ngFor="let file of task?.taskFiles; let i = index;"
                                             class="h-full relative w-10rem h-10rem border-3 border-transparent border-round hover:bg-primary transition-duration-100 cursor-auto"
                                             style="padding: 1px;">
                                            <div class="w-full h-full border-round shadow-2 flex align-items-center justify-content-center"
                                                 pTooltip="{{file.fileName}} - {{file.fileSize | fileSize}}"
                                                 tooltipPosition="top">
                                                <div
                                                        style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                                    <div
                                                            style="height: 80px; width: 100%; display: flex; align-items: center; justify-content: center;">
                                                        <ng-container
                                                                *ngIf="file.contentType.startsWith('image'); else nonImageTemplate">
                                                            <img
                                                                    (error)="imgLoaded[file.fileId] = false"
                                                                    (load)="imgLoaded[file.fileId] = true"
                                                                    [alt]="file.fileId"
                                                                    [src]="imgLoaded[file.fileId] ? (filesBaseUrl + '/' + file.fileId + '/thumbnail') : 'assets/layout/images/placeholder.png'"
                                                                    class="px-1"
                                                                    style="object-fit: cover; width: 100%; height: 70px; border-radius: 5px;">

                                                        </ng-container>
                                                        <ng-template #nonImageTemplate>
                        <span style="display: flex;"><svg fill="none" style="display:block" viewBox="0 0 100 117"
                                                          width="40.32px" xmlns="http://www.w3.org/2000/svg"><path
                                clip-rule="evenodd" d="
				M 0 5
				c 0 0 0 -4 5 -5
				H 63
				l 26 28
				v 82
				c 0 0 0 4 -5 5
				h -79
				c 0 0 -4 0 -5 -5
				Z" fill="#e5e8eb" fill-rule="evenodd"></path><path clip-rule="evenodd" d="
				M 63 0
			 	L 89 28
			 	H 66
			 	C 66 28 63 28 63 25
			 	V 63
			 	Z" fill="#535c69" fill-rule="evenodd" opacity="0.3"></path><svg height="33" width="65" x="35"
                                                                                 xmlns="http://www.w3.org/2000/svg"
                                                                                 y="53"><rect
                                [attr.fill]="getFileDetails(file.fileName).color" height="33" rx="2" ry="2" width="100%"
                                x="0"
                                y="0"></rect><text [attr.x]="getFileDetails(file.fileName).x" dominant-baseline="middle"
                                                   fill="#fff"
                                                   style="color:#fff; font-family: OpenSans-Semibold, 'Open Sans', Helvetica, Arial, sans-serif; font-weight: 500; font-size: 22px; line-height: 25px;"
                                                   y="54%">{{ getFileDetails(file.fileName).extension }}</text></svg></svg></span>
                                                        </ng-template>
                                                    </div>
                                                    <div
                                                            style="overflow: hidden; text-overflow: ellipsis; max-width: 100px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; word-wrap: break-word; overflow-wrap: break-word;">
                                                        <p style="font-size: 12px;">{{ getTruncatedFileName(file.fileName) }}</p>
                                                    </div>
                                                </div>
                                            </div>

                                            <button #buttonOp (click)="$event.stopPropagation(); downloadFile(file)"
                                                    [id]="file.fileId"
                                                    [loading]="isLoading && downloadingFileId  === file.fileId"
                                                    [style.display]="defaultDisplay"
                                                    class="p-button-primary text-sm absolute justify-content-center align-items-center cursor-pointer w-2rem h-2rem"
                                                    icon="pi pi-download"
                                                    pButton
                                                    pRipple
                                                    pTooltip="Descargar archivo" style="top: -1px; right: -1px;"
                                                    tooltipPosition="top"
                                                    type="button"></button>
                                        </div>
                                    </div>
                                </div>
                            </ng-template>
                        </p-fileUpload>
                    </div>
                </div>
                <div *ngIf="task.replacedParts.length == 0" class="col-12 field">
                    <div class="flex flex-column gap-2 field border-1 surface-border border-round">
                        <div [ngClass]="valRadio==='Yes' ? ' border-bottom-1 surface-border' : ''"
                             class="flex justify-content-between ">
                                   <span class="text-900 font-semibold p-3">
                            Cambio de Equipo</span>
                            <div class="flex flex-wrap gap-3 pr-3">
                                <div class="flex align-items-center">
                                    <p-radioButton
                                            [(ngModel)]="valRadio"
                                            [disabled]="!!task.taskEndDate"
                                            inputId="yes"
                                            name="yesno"
                                            value="Yes"/>
                                    <label class="ml-2" for="yes">
                                        Si
                                    </label>
                                </div>

                                <div class="flex align-items-center">
                                    <p-radioButton
                                            [(ngModel)]="valRadio"
                                            [disabled]="!!task.taskEndDate"
                                            inputId="no"
                                            name="yesno"
                                            value="No"/>
                                    <label class="ml-2" for="no">
                                        No
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div *ngIf="valRadio==='Yes'" class="flex p-3">
                            <div class="w-full">
                                <div class="flex justify-content-between align-items-center mb-2">
                                    <textarea (focus)="onReplacementFocus()"
                                              [formControl]="replacementControl"
                                              class="w-full" name="replacement"
                                              pInputTextarea placeholder="Escribe una descripción del cambio de equipo..."
                                              style="resize: none"
                                              type="text"></textarea>
                                </div>
                                <div *ngIf="showNewReplacementAttachment" class="grid p-fluid formgrid">
                                    <div class="col-12">
                                        <div class="border-1 surface-border border-round field">
                                            <p-fileUpload #fileUploader (onSelect)="onReplacementUpload($event)"
                                                          (onUpload)="onReplacementUpload($event)"
                                                          [auto]="true"
                                                          [customUpload]="true" [multiple]="true" [showCancelButton]="false"
                                                          [showUploadButton]="false" maxFileSize="10000000"
                                                          styleClass="border-1 surface-border surface-card border-round">
                                                <ng-template pTemplate="content">
                                                    <div (click)="fileUploader.advancedFileInput.nativeElement.click()"
                                                         class="h-10rem overflow-y-auto border-round"
                                                         style="cursor: copy">
                                                        <div *ngIf="!newReplacementFiles.length"
                                                             class="flex flex-column w-full h-full justify-content-center align-items-center">
                                                            <i class="pi pi-file text-4xl text-primary"></i>
                                                            <span class="block font-semibold text-900 text-lg mt-3">Arrastre o seleccione archivos</span>
                                                        </div>
                                                        <div *ngIf="newReplacementFiles.length" class="flex flex-wrap border-round">
                                                            <div (mouseenter)="onNewReplacementFileMouseOver(file)"
                                                                 (mouseleave)="onNewReplacementFileMouseLeave(file)"
                                                                 *ngFor="let file of newReplacementFiles; let i = index;"
                                                                 class="h-full relative w-10rem h-10rem border-3 border-transparent border-round hover:bg-primary transition-duration-100 cursor-auto"
                                                                 style="padding: 1px;">
                                                                <div class="w-full h-full border-round shadow-2 flex align-items-center justify-content-center"
                                                                     pTooltip="{{file.name}} - {{file.size | fileSize}}"
                                                                     tooltipPosition="top">
                                                                    <div
                                                                            style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                                                        <div
                                                                                style="height: 80px; width: 100%; display: flex; align-items: center; justify-content: center;">
                                                                            <ng-container
                                                                                    *ngIf="file.type.startsWith('image'); else nonImageTemplate">
                                                                                <img [alt]="file.name" [src]="file.objectURL" class="px-1"
                                                                                     style="object-fit: cover; width: 100%; height: 70px; border-radius: 5px;">
                                                                            </ng-container>
                                                                            <ng-template #nonImageTemplate>
                        <span style="display: flex;"><svg fill="none" style="display:block" viewBox="0 0 100 117"
                                                          width="40.32px" xmlns="http://www.w3.org/2000/svg"><path
                                clip-rule="evenodd" d="
				M 0 5
				c 0 0 0 -4 5 -5
				H 63
				l 26 28
				v 82
				c 0 0 0 4 -5 5
				h -79
				c 0 0 -4 0 -5 -5
				Z" fill="#e5e8eb" fill-rule="evenodd"></path><path clip-rule="evenodd" d="
				M 63 0
			 	L 89 28
			 	H 66
			 	C 66 28 63 28 63 25
			 	V 63
			 	Z" fill="#535c69" fill-rule="evenodd" opacity="0.3"></path><svg height="33" width="65" x="35"
                                                                                 xmlns="http://www.w3.org/2000/svg"
                                                                                 y="53"><rect
                                [attr.fill]="getFileDetails(file.name).color" height="33" rx="2" ry="2" width="100%"
                                x="0"
                                y="0"></rect><text [attr.x]="getFileDetails(file.name).x" dominant-baseline="middle"
                                                   fill="#fff"
                                                   style="color:#fff; font-family: OpenSans-Semibold, 'Open Sans', Helvetica, Arial, sans-serif; font-weight: 500; font-size: 22px; line-height: 25px;"
                                                   y="54%">{{ getFileDetails(file.name).extension }}</text></svg></svg></span>
                                                                            </ng-template>
                                                                        </div>
                                                                        <div
                                                                                style="overflow: hidden; text-overflow: ellipsis; max-width: 100px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; word-wrap: break-word; overflow-wrap: break-word;">
                                                                            <p style="font-size: 12px;">{{ getTruncatedFileName(file.name) }}</p>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <button #buttonEl (click)="$event.stopPropagation(); removeReplacementFile(file)"

                                                                        [id]="file.name"
                                                                        [style.display]="defaultDisplay"
                                                                        class="p-button-primary text-sm absolute justify-content-center align-items-center cursor-pointer w-2rem h-2rem"
                                                                        icon="pi pi-times"
                                                                        pButton
                                                                        pRipple pTooltip="Eliminar archivo"
                                                                        style="top: -1px; left:-1px;"
                                                                        tooltipPosition="top"
                                                                        type="button"></button>
                                                                <button #buttonOp (click)="$event.stopPropagation(); downloadReplacementFile(file)"

                                                                        [id]="file.name"
                                                                        [loading]="isLoading && downloadingFileId  === file.fileId"
                                                                        [style.display]="defaultDisplay"
                                                                        class="p-button-primary text-sm absolute justify-content-center align-items-center cursor-pointer w-2rem h-2rem"
                                                                        icon="pi pi-download"
                                                                        pButton
                                                                        pRipple pTooltip="Descargar archivo"
                                                                        style="top: -1px; right: -1px;"
                                                                        tooltipPosition="top"
                                                                        type="button"></button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </ng-template>
                                            </p-fileUpload>

                                        </div>
                                    </div>
                                </div>
                                <div *ngIf="focusedReplacement" class="flex justify-content-end align-items-end">
                                    <button (click)="onReplacementFileUpload()" [loadingIcon]="'pi pi-paperclip'" [loading]="isLoading"
                                            class="p-button-secondary p-button-sm p-button-outlined mr-3 w-auto"
                                            icon="pi pi-paperclip" pButton pRipple></button>
                                    <button (click)="onReplacement()" [loading]="isLoading"
                                            class="p-button-primary p-button-sm p-button-outlined mr-3 w-auto"
                                            icon="pi pi-save"
                                            label="Guardar"
                                            pButton pRipple>
                                    </button>
                                    <button (click)="onReplacementCancel()" [loadingIcon]="'pi pi-times'" [loading]="isLoading"
                                            class="p-button-danger p-button-sm p-button-outlined w-auto" icon="pi pi-times"
                                            label="Cancelar" pButton pRipple></button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <div *ngIf="!editReplacement && (task.replacedParts.length != 0)" class="col-12 field">
                    <div class="flex flex-column gap-2 field border-1 surface-border border-round">
                        <div class="flex justify-content-between border-bottom-1 surface-border p-3">
                            <div>
                                <span class="text-900 font-semibold">Cambio de Equipo</span>
                                <span class="block text-700">{{ task.replacedParts[0].txDate | date: 'dd/MM/yyyy, HH:mm' }}</span>
                            </div>
                            <div *ngIf="!task.taskEndDate">
                                <button (click)="onReplacementButtonClick(); menu.toggle($event)"
                                        class="p-button-rounded p-button-text p-button-secondary p-trigger"
                                        icon="pi pi-ellipsis-v" pButton
                                        pRipple
                                        type="button"></button>
                                <p-tieredMenu #menu [model]="replacementMenuItems" [popup]="true" appendTo="body"></p-tieredMenu>
                            </div>
                        </div>
                        <div class="p-3">
                            <span class="block text-900" style="word-break: break-all;" [innerHTML] = "task.replacedParts[0].replacedPartDescription | breakLine"></span>
                            <div *ngIf="task.replacedParts[0].replacedPartFiles.length > 0" class="grid p-fluid formgrid">
                                <div class="col-12">
                                    <p-fileUpload #fileUploader [auto]="true"
                                                  [customUpload]="true"
                                                  [disabled]="true" [multiple]="true" [showCancelButton]="false"
                                                  [showUploadButton]="false" maxFileSize="10000000"
                                                  styleClass="border-1 surface-border surface-card border-round">
                                        <ng-template pTemplate="content">
                                            <div (click)="fileUploader.advancedFileInput.nativeElement.click()"
                                                 class="h-10rem overflow-y-auto border-round"
                                            >
                                                <div *ngIf="!task.replacedParts[0].replacedPartFiles.length"
                                                     class="flex flex-column w-full h-full justify-content-center align-items-center">
                                                    <i class="pi pi-file-excel text-900 text-4xl"></i>
                                                    <span class="block font-semibold text-900 text-lg mt-3">No hay archivos adjuntos</span>
                                                </div>
                                                <div *ngIf="task.replacedParts[0].replacedPartFiles.length" class="flex flex-wrap border-round">
                                                    <div (mouseenter)="onFileMouseOver(file)"
                                                         (mouseleave)="onFileMouseLeave(file)"
                                                         *ngFor="let file of task.replacedParts[0].replacedPartFiles; let i = index;"
                                                         class="h-full relative w-10rem h-10rem border-3 border-transparent border-round hover:bg-primary transition-duration-100 cursor-auto"
                                                         style="padding: 1px;">
                                                        <div class="w-full h-full border-round shadow-2 flex align-items-center justify-content-center"
                                                             pTooltip="{{file.fileName}} - {{file.fileSize | fileSize}}"
                                                             tooltipPosition="top">
                                                            <div
                                                                    style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                                                <div
                                                                        style="height: 80px; width: 100%; display: flex; align-items: center; justify-content: center;">
                                                                    <ng-container
                                                                            *ngIf="file.contentType.startsWith('image'); else nonImageTemplate">
                                                                        <img
                                                                                (error)="imgLoaded[file.fileId] = false"
                                                                                (load)="imgLoaded[file.fileId] = true"
                                                                                [alt]="file.fileId"
                                                                                [src]="imgLoaded[file.fileId] ? (filesBaseUrl + '/' + file.fileId + '/thumbnail') : 'assets/layout/images/placeholder.png'"
                                                                                class="px-1"
                                                                                style="object-fit: cover; width: 100%; height: 70px; border-radius: 5px;">

                                                                    </ng-container>
                                                                    <ng-template #nonImageTemplate>
                        <span style="display: flex;"><svg fill="none" style="display:block" viewBox="0 0 100 117"
                                                          width="40.32px" xmlns="http://www.w3.org/2000/svg"><path
                                clip-rule="evenodd" d="
				M 0 5
				c 0 0 0 -4 5 -5
				H 63
				l 26 28
				v 82
				c 0 0 0 4 -5 5
				h -79
				c 0 0 -4 0 -5 -5
				Z" fill="#e5e8eb" fill-rule="evenodd"></path><path clip-rule="evenodd" d="
				M 63 0
			 	L 89 28
			 	H 66
			 	C 66 28 63 28 63 25
			 	V 63
			 	Z" fill="#535c69" fill-rule="evenodd" opacity="0.3"></path><svg height="33" width="65" x="35"
                                                                                 xmlns="http://www.w3.org/2000/svg"
                                                                                 y="53"><rect
                                [attr.fill]="getFileDetails(file.fileName).color" height="33" rx="2" ry="2" width="100%"
                                x="0"
                                y="0"></rect><text [attr.x]="getFileDetails(file.fileName).x" dominant-baseline="middle"
                                                   fill="#fff"
                                                   style="color:#fff; font-family: OpenSans-Semibold, 'Open Sans', Helvetica, Arial, sans-serif; font-weight: 500; font-size: 22px; line-height: 25px;"
                                                   y="54%">{{ getFileDetails(file.fileName).extension }}</text></svg></svg></span>
                                                                    </ng-template>
                                                                </div>
                                                                <div
                                                                        style="overflow: hidden; text-overflow: ellipsis; max-width: 100px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; word-wrap: break-word; overflow-wrap: break-word;">
                                                                    <p style="font-size: 12px;">{{ getTruncatedFileName(file.fileName) }}</p>
                                                                </div>
                                                                <div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <button #buttonOp (click)="$event.stopPropagation(); downloadReplacementFile(file)"
                                                                [id]="file.fileId"
                                                                [loading]="isLoading && downloadingFileId  === file.fileId"
                                                                [style.display]="defaultDisplay"
                                                                class="p-button-primary text-sm absolute justify-content-center align-items-center cursor-pointer w-2rem h-2rem"
                                                                icon="pi pi-download"
                                                                pButton
                                                                pRipple
                                                                pTooltip="Descargar archivo" style="top: -1px; right: -1px;"
                                                                tooltipPosition="top"
                                                                type="button"></button>


                                                    </div>
                                                </div>
                                            </div>
                                        </ng-template>
                                    </p-fileUpload>
                                    <div class="mx-3" style="text-align: right;">
                                        <span class="text-900 font-semibold"><i
                                                class="pi pi-paperclip text-700 mx-2"></i>{{ task.replacedParts[0].replacedPartFiles.length }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div *ngIf="editReplacement && (task.replacedParts.length != 0)" class="col-12 field">
                    <div class="flex flex-column gap-2 field border-1 surface-border border-round">
                        <div class="flex justify-content-between border-bottom-1 surface-border p-3">
                            <div>
                                <span class="text-900 font-semibold">Cambio de Equipo</span>
                                <span class="block text-700">{{ task.replacedParts[0].txDate | date: 'dd/MM/yyyy, HH:mm' }}</span>
                            </div>
                        </div>
                        <div class="p-3">
                            <div class="w-full">
                                <div class="flex justify-content-between align-items-center mb-2">
                                    <textarea
                                            [formControl]="editReplacementControl"
                                            class="w-full" name="replacement"
                                            pInputTextarea placeholder="Escribe una descripción del cambio de equipo..."
                                            style="resize: none"
                                            type="text"></textarea>
                                </div>
                                <div *ngIf="showEditReplacementAttachment" class="grid p-fluid formgrid">
                                    <div class="col-12">
                                        <div class="border-1 surface-border border-round field">
                                            <p-fileUpload #fileUploader (onSelect)="onEditReplacementUpload($event)"
                                                          (onUpload)="onEditReplacementUpload($event)"
                                                          [auto]="true"
                                                          [customUpload]="true" [multiple]="true" [showCancelButton]="false"
                                                          [showUploadButton]="false" maxFileSize="10000000"
                                                          styleClass="border-1 surface-border surface-card border-round">
                                                <ng-template pTemplate="content">
                                                    <div (click)="fileUploader.advancedFileInput.nativeElement.click()"
                                                         class="h-10rem overflow-y-auto border-round"
                                                         style="cursor: copy">
                                                        <div *ngIf="!editReplacementFiles.length"
                                                             class="flex flex-column w-full h-full justify-content-center align-items-center">
                                                            <i class="pi pi-file text-4xl text-primary"></i>
                                                            <span class="block font-semibold text-900 text-lg mt-3">Arrastre o seleccione archivos</span>
                                                        </div>
                                                        <div *ngIf="editReplacementFiles.length" class="flex flex-wrap border-round">
                                                            <div (mouseenter)="onEditReplacementFileMouseOver(file)"
                                                                 (mouseleave)="onEditReplacementFileMouseLeave(file)"
                                                                 *ngFor="let file of editReplacementFiles; let i = index;"
                                                                 class="h-full relative w-10rem h-10rem border-3 border-transparent border-round hover:bg-primary transition-duration-100 cursor-auto"
                                                                 style="padding: 1px;">
                                                                <div class="w-full h-full border-round shadow-2 flex align-items-center justify-content-center"
                                                                     pTooltip="{{file.name}} - {{file.size | fileSize}}"
                                                                     tooltipPosition="top">
                                                                    <div
                                                                            style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                                                        <div
                                                                                style="height: 80px; width: 100%; display: flex; align-items: center; justify-content: center;">
                                                                            <ng-container
                                                                                    *ngIf="file.type.startsWith('image'); else nonImageTemplate">
                                                                                <img [alt]="file.name" [src]="file.objectURL" class="px-1"
                                                                                     style="object-fit: cover; width: 100%; height: 70px; border-radius: 5px;">
                                                                            </ng-container>
                                                                            <ng-template #nonImageTemplate>
                        <span style="display: flex;"><svg fill="none" style="display:block" viewBox="0 0 100 117"
                                                          width="40.32px" xmlns="http://www.w3.org/2000/svg"><path
                                clip-rule="evenodd" d="
				M 0 5
				c 0 0 0 -4 5 -5
				H 63
				l 26 28
				v 82
				c 0 0 0 4 -5 5
				h -79
				c 0 0 -4 0 -5 -5
				Z" fill="#e5e8eb" fill-rule="evenodd"></path><path clip-rule="evenodd" d="
				M 63 0
			 	L 89 28
			 	H 66
			 	C 66 28 63 28 63 25
			 	V 63
			 	Z" fill="#535c69" fill-rule="evenodd" opacity="0.3"></path><svg height="33" width="65" x="35"
                                                                                 xmlns="http://www.w3.org/2000/svg"
                                                                                 y="53"><rect
                                [attr.fill]="getFileDetails(file.name).color" height="33" rx="2" ry="2" width="100%"
                                x="0"
                                y="0"></rect><text [attr.x]="getFileDetails(file.name).x" dominant-baseline="middle"
                                                   fill="#fff"
                                                   style="color:#fff; font-family: OpenSans-Semibold, 'Open Sans', Helvetica, Arial, sans-serif; font-weight: 500; font-size: 22px; line-height: 25px;"
                                                   y="54%">{{ getFileDetails(file.name).extension }}</text></svg></svg></span>
                                                                            </ng-template>
                                                                        </div>
                                                                        <div
                                                                                style="overflow: hidden; text-overflow: ellipsis; max-width: 100px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; word-wrap: break-word; overflow-wrap: break-word;">
                                                                            <p style="font-size: 12px;">{{ getTruncatedFileName(file.name) }}</p>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <button #buttonEl (click)="$event.stopPropagation(); removeEditReplacementFile(file)"

                                                                        [id]="file.name"
                                                                        [style.display]="defaultDisplay"
                                                                        class="p-button-primary text-sm absolute justify-content-center align-items-center cursor-pointer w-2rem h-2rem"
                                                                        icon="pi pi-times"
                                                                        pButton
                                                                        pRipple pTooltip="Eliminar archivo"
                                                                        style="top: -1px; left:-1px;"
                                                                        tooltipPosition="top"
                                                                        type="button"></button>
                                                                <button #buttonOp
                                                                        (click)="$event.stopPropagation(); downloadEditReplacementFile(file)"

                                                                        [id]="file.name"
                                                                        [loading]="isLoading && downloadingFileId  === file.id"
                                                                        [style.display]="defaultDisplay"
                                                                        class="p-button-primary text-sm absolute justify-content-center align-items-center cursor-pointer w-2rem h-2rem"
                                                                        icon="pi pi-download"
                                                                        pButton
                                                                        pRipple pTooltip="Descargar archivo"
                                                                        style="top: -1px; right: -1px;"
                                                                        tooltipPosition="top"
                                                                        type="button"></button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </ng-template>
                                            </p-fileUpload>

                                        </div>
                                    </div>
                                </div>
                                <div class="flex justify-content-end align-items-end">
                                    <button (click)="onEditReplacementFileUpload()" [loadingIcon]="'pi pi-paperclip'" [loading]="isLoading"
                                            class="p-button-secondary p-button-sm p-button-outlined mr-3 w-auto"
                                            icon="pi pi-paperclip" pButton pRipple></button>
                                    <button (click)="onEditReplacement()" [loading]="isLoading"
                                            class="p-button-primary p-button-sm p-button-outlined mr-3 w-auto"
                                            icon="pi pi-save"
                                            label="Guardar"
                                            pButton pRipple>
                                    </button>
                                    <button (click)="onEditReplacementCancel()" [loadingIcon]="'pi pi-times'" [loading]="isLoading"
                                            class="p-button-danger p-button-sm p-button-outlined w-auto" icon="pi pi-times"
                                            label="Cancelar" pButton pRipple></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div *ngIf="!task.taskEndDate" class="col-12 field">
                    <div class="flex flex-column gap-2 field border-1 surface-border border-round">
                        <div class="flex justify-content-between border-bottom-1 surface-border p-3">
                            <label class="font-semibold text-900" for="status">Cambiar Estado de la Tarea</label>
                        </div>
                        <div class="px-3 pb-3 pt-2">
                            <p-dropdown (onChange)="onStatusChange($event)" [(ngModel)]="selectedStatus" [appendTo]="sidebar"
                                        [filter]="false"
                                        [options]="statusItems"
                                        class="flex-1 w-full"
                                        id=status placeholder="Seleccionar prioridad"></p-dropdown>
                        </div>
                    </div>

                </div>


                <div *ngIf="task.taskEndDate" class="col-12 field">
                    <div class="flex flex-column gap-2 field border-1 surface-border border-round">
                        <span class="text-900 font-semibold border-bottom-1 surface-border p-3">Tarea Finalizada el {{ task.taskEndDate | date: 'dd/MM/yyyy, HH:mm' }}</span>
                        <div class="flex justify-content-between px-3">
                            <label class="font-semibold text-900" for="feedback">Calificación de la Tarea</label>
                            <p-rating [cancel]="false" [disabled]="true" [iconOffStyle]="{'fontSize':'12px'}" [iconOnStyle]="{'fontSize':'12px'}"
                                      [ngModel]="taskRating" [readonly]="true"></p-rating>
                        </div>
                        <div *ngIf="daysOfDifference > 0" class="flex justify-content-between px-3 pb-2">
                            <p-tag [style]="{background: '#FF000080'}"
                                   value="Terminada con {{daysOfDifference}} días de retraso"></p-tag>
                        </div>
                        <div class="px-3 pb-3">
                        <textarea [(ngModel)]="taskFeedback" [readonly]="true" [rows]="2"
                                  class="w-full"
                                  id="feedback"
                                  name="description" pInputTextarea
                                  placeholder="No hay calificación de la tarea"
                                  style="resize: none"
                                  type="text"></textarea>
                        </div>

                    </div>

                </div>

            </div>
            <p-tabView orientation="left">
                <p-tabPanel class="line-height-3 m-0" header="Comentarios">
                    <div class="flex border-round mb-4 p-0">
                        <img
                                (error)="imgLoaded[userId] = false"
                                (load)="imgLoaded[userId] = true"
                                [src]="imgLoaded[userId] ? (baseUrl + '/' + userId + '/profile-picture/thumbnail') : 'assets/layout/images/avatar_thumbnail.png'"
                                alt="{{userId}}"
                                style="width: 42px; height: 42px; border-radius: 50%; object-fit: cover;">
                        <div class="card w-full ml-3 p-4">
                            <div class="flex justify-content-between align-items-center mb-2">
                                <textarea (focus)="onCommentFocus()" [formControl]="newCommentControl"
                                          class="w-full" name="comment"
                                          pInputTextarea placeholder="Escribe un comentario..." style="resize: none"
                                          type="text"></textarea>
                            </div>
                            <div *ngIf="showNewCommentAttachment" class="grid p-fluid formgrid">
                                <div class="col-12">
                                    <div class="border-1 surface-border border-round field">
                                        <p-fileUpload #fileUploader (onSelect)="onUpload($event)" (onUpload)="onUpload($event)"
                                                      [auto]="true"
                                                      [customUpload]="true" [multiple]="true" [showCancelButton]="false"
                                                      [showUploadButton]="false" maxFileSize="10000000"
                                                      styleClass="border-1 surface-border surface-card border-round">
                                            <ng-template pTemplate="content">
                                                <div (click)="fileUploader.advancedFileInput.nativeElement.click()"
                                                     class="h-10rem overflow-y-auto border-round"
                                                     style="cursor: copy">
                                                    <div *ngIf="!newCommentFiles.length"
                                                         class="flex flex-column w-full h-full justify-content-center align-items-center">
                                                        <i class="pi pi-file text-4xl text-primary"></i>
                                                        <span class="block font-semibold text-900 text-lg mt-3">Arrastre o seleccione archivos</span>
                                                    </div>
                                                    <div *ngIf="newCommentFiles.length" class="flex flex-wrap border-round">
                                                        <div (mouseenter)="onNewFileMouseOver(file)"
                                                             (mouseleave)="onNewFileMouseLeave(file)"
                                                             *ngFor="let file of newCommentFiles; let i = index;"
                                                             class="h-full relative w-10rem h-10rem border-3 border-transparent border-round hover:bg-primary transition-duration-100 cursor-auto"
                                                             style="padding: 1px;">
                                                            <div class="w-full h-full border-round shadow-2 flex align-items-center justify-content-center"
                                                                 pTooltip="{{file.name}} - {{file.size | fileSize}}"
                                                                 tooltipPosition="top">
                                                                <div
                                                                        style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                                                    <div
                                                                            style="height: 80px; width: 100%; display: flex; align-items: center; justify-content: center;">
                                                                        <ng-container
                                                                                *ngIf="file.type.startsWith('image'); else nonImageTemplate">
                                                                            <img [alt]="file.name" [src]="file.objectURL" class="px-1"
                                                                                 style="object-fit: cover; width: 100%; height: 70px; border-radius: 5px;">
                                                                        </ng-container>
                                                                        <ng-template #nonImageTemplate>
                        <span style="display: flex;"><svg fill="none" style="display:block" viewBox="0 0 100 117"
                                                          width="40.32px" xmlns="http://www.w3.org/2000/svg"><path
                                clip-rule="evenodd" d="
				M 0 5
				c 0 0 0 -4 5 -5
				H 63
				l 26 28
				v 82
				c 0 0 0 4 -5 5
				h -79
				c 0 0 -4 0 -5 -5
				Z" fill="#e5e8eb" fill-rule="evenodd"></path><path clip-rule="evenodd" d="
				M 63 0
			 	L 89 28
			 	H 66
			 	C 66 28 63 28 63 25
			 	V 63
			 	Z" fill="#535c69" fill-rule="evenodd" opacity="0.3"></path><svg height="33" width="65" x="35"
                                                                                 xmlns="http://www.w3.org/2000/svg"
                                                                                 y="53"><rect
                                [attr.fill]="getFileDetails(file.name).color" height="33" rx="2" ry="2" width="100%"
                                x="0"
                                y="0"></rect><text [attr.x]="getFileDetails(file.name).x" dominant-baseline="middle"
                                                   fill="#fff"
                                                   style="color:#fff; font-family: OpenSans-Semibold, 'Open Sans', Helvetica, Arial, sans-serif; font-weight: 500; font-size: 22px; line-height: 25px;"
                                                   y="54%">{{ getFileDetails(file.name).extension }}</text></svg></svg></span>
                                                                        </ng-template>
                                                                    </div>
                                                                    <div
                                                                            style="overflow: hidden; text-overflow: ellipsis; max-width: 100px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; word-wrap: break-word; overflow-wrap: break-word;">
                                                                        <p style="font-size: 12px;">{{ getTruncatedFileName(file.name) }}</p>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <button #buttonEl (click)="$event.stopPropagation(); removeFile(file)"

                                                                    [id]="file.name"
                                                                    [style.display]="defaultDisplay"
                                                                    class="p-button-primary text-sm absolute justify-content-center align-items-center cursor-pointer w-2rem h-2rem"
                                                                    icon="pi pi-times"
                                                                    pButton
                                                                    pRipple pTooltip="Eliminar archivo"
                                                                    style="top: -1px; left:-1px;"
                                                                    tooltipPosition="top"
                                                                    type="button"></button>
                                                            <button #buttonOp (click)="$event.stopPropagation(); downloadFile(file)"

                                                                    [id]="file.name"
                                                                    [loading]="isLoading && downloadingFileId  === file.fileId"
                                                                    [style.display]="defaultDisplay"
                                                                    class="p-button-primary text-sm absolute justify-content-center align-items-center cursor-pointer w-2rem h-2rem"
                                                                    icon="pi pi-download"
                                                                    pButton
                                                                    pRipple pTooltip="Descargar archivo"
                                                                    style="top: -1px; right: -1px;"
                                                                    tooltipPosition="top"
                                                                    type="button"></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </ng-template>
                                        </p-fileUpload>

                                    </div>
                                </div>
                            </div>
                            <div *ngIf="focusedComment" class="flex justify-content-end align-items-end">
                                <button (click)="onFileUpload()" [loadingIcon]="'pi pi-paperclip'" [loading]="isLoading"
                                        class="p-button-secondary p-button-sm p-button-outlined mr-3"
                                        icon="pi pi-paperclip" pButton pRipple></button>
                                <button (click)="onComment()" [loading]="isLoading" class="p-button-primary p-button-sm p-button-outlined mr-3"
                                        icon="pi pi-send"
                                        label="Enviar"
                                        pButton pRipple>
                                </button>
                                <button (click)="onCommentCancel()" [loadingIcon]="'pi pi-times'" [loading]="isLoading"
                                        class="p-button-danger p-button-sm p-button-outlined" icon="pi pi-times"
                                        label="Cancelar" pButton pRipple></button>
                            </div>
                        </div>
                    </div>
                    <div *ngFor="let comment of task.taskComments" class="flex border-round mb-4 p-0">
                        <img
                                (error)="imgLoaded[comment.user.userId] = false"
                                (load)="imgLoaded[comment.user.userId] = true"
                                [src]="imgLoaded[comment.user.userId] ? (baseUrl + '/' + comment.user.userId + '/profile-picture/thumbnail') : 'assets/layout/images/avatar_thumbnail.png'"
                                alt="{{comment.user.userId}}"
                                style="width: 42px; height: 42px; border-radius: 50%; object-fit: cover;">
                        <div *ngIf="!(editComment && selectedCommentId === comment.taskCommentId)" class="card w-full ml-3 p-4">
                            <div class="flex justify-content-between align-items-center mb-2">
                                <div>
                                    <span class="block text-900 font-semibold">{{ comment.user.firstName }} {{ comment.user.lastName }}</span>
                                    <span class="block text-700">{{ comment.txDate | date: 'dd/MM/yyyy, HH:mm' }}</span>
                                </div>
                                <div *ngIf="comment.user.userId === userId">
                                    <button (click)="onButtonClick(comment.taskCommentId); menu.toggle($event)"
                                            class="p-button-rounded p-button-text p-button-secondary p-trigger"
                                            icon="pi pi-ellipsis-v" pButton
                                            pRipple
                                            type="button"></button>
                                    <p-tieredMenu #menu [model]="menuItems" [popup]="true" appendTo="body"></p-tieredMenu>
                                </div>
                            </div>
                            <span class="block text-900" style="word-break: break-all;" [innerHTML]="comment.taskComment | breakLine"></span>
                            <div *ngIf="comment.taskCommentFiles.length > 0" class="grid p-fluid formgrid">
                                <div class="col-12">
                                    <p-fileUpload #fileUploader [auto]="true"
                                                  [customUpload]="true"
                                                  [disabled]="true" [multiple]="true" [showCancelButton]="false"
                                                  [showUploadButton]="false" maxFileSize="10000000"
                                                  styleClass="border-1 surface-border surface-card border-round">
                                        <ng-template pTemplate="content">
                                            <div (click)="fileUploader.advancedFileInput.nativeElement.click()"
                                                 class="h-10rem overflow-y-auto border-round"
                                            >
                                                <div *ngIf="!comment.taskCommentFiles.length"
                                                     class="flex flex-column w-full h-full justify-content-center align-items-center">
                                                    <i class="pi pi-file-excel text-900 text-4xl"></i>
                                                    <span class="block font-semibold text-900 text-lg mt-3">No hay archivos adjuntos</span>
                                                </div>
                                                <div *ngIf="comment.taskCommentFiles.length" class="flex flex-wrap border-round">
                                                    <div (mouseenter)="onFileMouseOver(file)"
                                                         (mouseleave)="onFileMouseLeave(file)"
                                                         *ngFor="let file of comment.taskCommentFiles; let i = index;"
                                                         class="h-full relative w-10rem h-10rem border-3 border-transparent border-round hover:bg-primary transition-duration-100 cursor-auto"
                                                         style="padding: 1px;">
                                                        <div class="w-full h-full border-round shadow-2 flex align-items-center justify-content-center"
                                                             pTooltip="{{file.fileName}} - {{file.fileSize | fileSize}}"
                                                             tooltipPosition="top">
                                                            <div
                                                                    style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                                                <div
                                                                        style="height: 80px; width: 100%; display: flex; align-items: center; justify-content: center;">
                                                                    <ng-container
                                                                            *ngIf="file.contentType.startsWith('image'); else nonImageTemplate">
                                                                        <img
                                                                                (error)="imgLoaded[file.fileId] = false"
                                                                                (load)="imgLoaded[file.fileId] = true"
                                                                                [alt]="file.fileId"
                                                                                [src]="imgLoaded[file.fileId] ? (filesBaseUrl + '/' + file.fileId + '/thumbnail') : 'assets/layout/images/placeholder.png'"
                                                                                class="px-1"
                                                                                style="object-fit: cover; width: 100%; height: 70px; border-radius: 5px;">

                                                                    </ng-container>
                                                                    <ng-template #nonImageTemplate>
                        <span style="display: flex;"><svg fill="none" style="display:block" viewBox="0 0 100 117"
                                                          width="40.32px" xmlns="http://www.w3.org/2000/svg"><path
                                clip-rule="evenodd" d="
				M 0 5
				c 0 0 0 -4 5 -5
				H 63
				l 26 28
				v 82
				c 0 0 0 4 -5 5
				h -79
				c 0 0 -4 0 -5 -5
				Z" fill="#e5e8eb" fill-rule="evenodd"></path><path clip-rule="evenodd" d="
				M 63 0
			 	L 89 28
			 	H 66
			 	C 66 28 63 28 63 25
			 	V 63
			 	Z" fill="#535c69" fill-rule="evenodd" opacity="0.3"></path><svg height="33" width="65" x="35"
                                                                                 xmlns="http://www.w3.org/2000/svg"
                                                                                 y="53"><rect
                                [attr.fill]="getFileDetails(file.fileName).color" height="33" rx="2" ry="2" width="100%"
                                x="0"
                                y="0"></rect><text [attr.x]="getFileDetails(file.fileName).x" dominant-baseline="middle"
                                                   fill="#fff"
                                                   style="color:#fff; font-family: OpenSans-Semibold, 'Open Sans', Helvetica, Arial, sans-serif; font-weight: 500; font-size: 22px; line-height: 25px;"
                                                   y="54%">{{ getFileDetails(file.fileName).extension }}</text></svg></svg></span>
                                                                    </ng-template>
                                                                </div>
                                                                <div
                                                                        style="overflow: hidden; text-overflow: ellipsis; max-width: 100px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; word-wrap: break-word; overflow-wrap: break-word;">
                                                                    <p style="font-size: 12px;">{{ getTruncatedFileName(file.fileName) }}</p>
                                                                </div>
                                                                <div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <button #buttonOp (click)="$event.stopPropagation(); downloadFile(file)"
                                                                [id]="file.fileId"
                                                                [loading]="isLoading && downloadingFileId  === file.fileId"
                                                                [style.display]="defaultDisplay"
                                                                class="p-button-primary text-sm absolute justify-content-center align-items-center cursor-pointer w-2rem h-2rem"
                                                                icon="pi pi-download"
                                                                pButton
                                                                pRipple
                                                                pTooltip="Descargar archivo" style="top: -1px; right: -1px;"
                                                                tooltipPosition="top"
                                                                type="button"></button>


                                                    </div>
                                                </div>
                                            </div>
                                        </ng-template>
                                    </p-fileUpload>
                                    <div class="mx-3" style="text-align: right;">
                                        <span class="text-900 font-semibold"><i
                                                class="pi pi-paperclip text-700 mx-2"></i>{{ comment.taskCommentFiles.length }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div *ngIf="(editComment && selectedCommentId === comment.taskCommentId)" class="card w-full ml-3 p-4">
                            <div class="mb-2">
                                <span class="block text-900 font-semibold">{{ comment.user.firstName }} {{ comment.user.lastName }}</span>
                                <span class="block text-700">{{ comment.txDate | date: 'dd/MM/yyyy, HH:mm' }}</span>
                            </div>
                            <div class="flex justify-content-between align-items-center mb-2">
                                <textarea [formControl]="editCommentControl" class="w-full" name="comment"
                                          pInputTextarea
                                          placeholder="Escribe un comentario..." style="resize: none"
                                          type="text"></textarea>
                            </div>
                            <div *ngIf="showEditCommentAttachment" class="grid p-fluid formgrid">
                                <div class="col-12">
                                    <div class="border-1 surface-border border-round field">
                                        <p-fileUpload #fileUploader (onSelect)="onEditUpload($event)" (onUpload)="onEditUpload($event)"
                                                      [auto]="true"
                                                      [customUpload]="true" [multiple]="true" [showCancelButton]="false"
                                                      [showUploadButton]="false" maxFileSize="10000000"
                                                      styleClass="border-1 surface-border surface-card border-round">
                                            <ng-template pTemplate="content">
                                                <div (click)="fileUploader.advancedFileInput.nativeElement.click()"
                                                     class="h-10rem overflow-y-auto border-round"
                                                     style="cursor: copy">
                                                    <div *ngIf="!editCommentFiles.length"
                                                         class="flex flex-column w-full h-full justify-content-center align-items-center">
                                                        <i class="pi pi-file text-4xl text-primary"></i>
                                                        <span class="block font-semibold text-900 text-lg mt-3">Arrastre o seleccione archivos</span>
                                                    </div>
                                                    <div *ngIf="editCommentFiles.length" class="flex flex-wrap border-round">
                                                        <div (mouseenter)="onEditFileMouseOver(file)"
                                                             (mouseleave)="onEditFileMouseLeave(file)"
                                                             *ngFor="let file of editCommentFiles; let i = index;"
                                                             class="h-full relative w-10rem h-10rem border-3 border-transparent border-round hover:bg-primary transition-duration-100 cursor-auto"
                                                             style="padding: 1px;">
                                                            <div class="w-full h-full border-round shadow-2 flex align-items-center justify-content-center"
                                                                 pTooltip="{{file.name}} - {{file.size | fileSize}}"
                                                                 tooltipPosition="top">
                                                                <div
                                                                        style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                                                    <div
                                                                            style="height: 80px; width: 100%; display: flex; align-items: center; justify-content: center;">
                                                                        <ng-container *ngIf="file.type.startsWith('image'); else nonImageTemplate">
                                                                            <img [alt]="file.name" [src]="file.objectURL"
                                                                                 class="px-1"
                                                                                 style="object-fit: cover; width: 100%; height: 70px; border-radius: 5px;">
                                                                        </ng-container>
                                                                        <ng-template #nonImageTemplate>
                        <span style="display: flex;"><svg fill="none" style="display:block" viewBox="0 0 100 117"
                                                          width="40.32px" xmlns="http://www.w3.org/2000/svg"><path
                                clip-rule="evenodd" d="
				M 0 5
				c 0 0 0 -4 5 -5
				H 63
				l 26 28
				v 82
				c 0 0 0 4 -5 5
				h -79
				c 0 0 -4 0 -5 -5
				Z" fill="#e5e8eb" fill-rule="evenodd"></path><path clip-rule="evenodd" d="
				M 63 0
			 	L 89 28
			 	H 66
			 	C 66 28 63 28 63 25
			 	V 63
			 	Z" fill="#535c69" fill-rule="evenodd" opacity="0.3"></path><svg height="33" width="65" x="35"
                                                                                 xmlns="http://www.w3.org/2000/svg"
                                                                                 y="53"><rect
                                [attr.fill]="getFileDetails(file.name).color" height="33" rx="2" ry="2" width="100%"
                                x="0"
                                y="0"></rect><text [attr.x]="getFileDetails(file.name).x" dominant-baseline="middle"
                                                   fill="#fff"
                                                   style="color:#fff; font-family: OpenSans-Semibold, 'Open Sans', Helvetica, Arial, sans-serif; font-weight: 500; font-size: 22px; line-height: 25px;"
                                                   y="54%">{{ getFileDetails(file.name).extension }}</text></svg></svg></span>
                                                                        </ng-template>
                                                                    </div>
                                                                    <div
                                                                            style="overflow: hidden; text-overflow: ellipsis; max-width: 100px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; word-wrap: break-word; overflow-wrap: break-word;">
                                                                        <p style="font-size: 12px;">{{ getTruncatedFileName(file.name) }}</p>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <button #buttonEl (click)="$event.stopPropagation(); removeEditFile(file)"

                                                                    [id]="file.name"
                                                                    [style.display]="defaultDisplay"
                                                                    class="p-button-primary text-sm absolute justify-content-center align-items-center cursor-pointer w-2rem h-2rem"
                                                                    icon="pi pi-times"
                                                                    pButton
                                                                    pRipple
                                                                    pTooltip="Eliminar archivo" style="top: -1px; left:-1px;"
                                                                    tooltipPosition="top"
                                                                    type="button"></button>
                                                            <button #buttonOp (click)="$event.stopPropagation(); downloadEditFile(file)"

                                                                    [id]="file.name"
                                                                    [loading]="isLoading && downloadingFileId  === file.id"
                                                                    [style.display]="defaultDisplay"
                                                                    class="p-button-primary text-sm absolute justify-content-center align-items-center cursor-pointer w-2rem h-2rem"
                                                                    icon="pi pi-download"
                                                                    pButton
                                                                    pRipple
                                                                    pTooltip="Descargar archivo" style="top: -1px; right: -1px;"
                                                                    tooltipPosition="top"
                                                                    type="button"></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </ng-template>
                                        </p-fileUpload>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-content-end align-items-end">

                                <button (click)="onEditFileUpload()" [loadingIcon]="'pi pi-paperclip'" [loading]="isLoading"
                                        class="p-button-secondary p-button-sm p-button-outlined mr-3"
                                        icon="pi pi-paperclip" pButton pRipple></button>
                                <button (click)="onEditComment()" [loading]="isLoading" class="p-button-primary p-button-sm p-button-outlined mr-3"
                                        icon="pi pi-save"
                                        label="Guardar"
                                        pButton pRipple>
                                </button>
                                <button (click)="onEditCommentCancel()" [loadingIcon]="'pi pi-times'" [loading]="isLoading"
                                        class="p-button-danger p-button-sm p-button-outlined" icon="pi pi-times"
                                        label="Cancelar" pButton pRipple></button>
                            </div>
                        </div>
                    </div>


                </p-tabPanel>
                <p-tabPanel *ngIf="isOwner" class="line-height-3 m-0 small-font" header="Historial">
                    <p-table [value]="taskHistory">
                        <ng-template pTemplate="header">
                            <tr>
                                <th>Fecha</th>
                                <th>Creado Por</th>
                                <th>Campo Actualizado</th>
                                <th>Actualización</th>
                            </tr>
                        </ng-template>
                        <ng-template let-history pTemplate="body">
                            <tr>
                                <td>{{ history.txDate | date: 'dd/MM/yyyy, HH:mm' }}</td>
                                <td>{{ history.user.firstName }} {{ history.user.lastName }}</td>
                                <td>{{ history.fieldName }}</td>
                                <td *ngIf="history.fieldName!== 'Fecha limite'">{{ history.previousValue }} -> {{ history.newValue }}</td>
                                <td *ngIf="history.fieldName === 'Fecha limite'">{{ history.previousValue | date: 'dd/MM/yyyy, HH:mm' }}
                                    -> {{ history.newValue | date: 'dd/MM/yyyy, HH:mm' }}
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </p-tabPanel>
            </p-tabView>
        </div>

        <div *ngIf="!task">
            <div style="display: flex; justify-content: center; align-items: center; height: 100vh;">
                <p-progressSpinner ariaLabel="Cargando..."></p-progressSpinner>
            </div>
        </div>
    </ng-template>
</p-sidebar>

<p-dialog [(visible)]="visibleAddFeedback" [baseZIndex]="10000" [draggable]="false" [modal]="true"
          [resizable]="false" [style]="{width: '30rem'}" header="Agregar Calificación">
    <div class="mb-3">
        <span class="text-600 font-medium">Por favor, califica el trabajo realizado</span>
    </div>
    <div class="flex flex-column mb-3">
        <div class="flex align-items-center justify-content-between mb-3">
            <label class="font-semibold text-900 field" for="givenFeedback">Calificación de la Tarea</label>
            <p-rating [autofocus]="false" [cancel]="false" [disabled]="false" [formControl]="taskRatingControl"
                      [iconOffStyle]="{'fontSize':'12px'}" [iconOnStyle]="{'fontSize':'12px'}"></p-rating>
        </div>
        <textarea [formControl]="taskFeedbackControl" [rows]="2" class="w-full" id="givenFeedback" name="description"
                  pInputTextarea placeholder="Calificación de la tarea"
                  style="resize: none" type="text"></textarea>
    </div>
    <div class="flex flex-wrap gap-2 justify-content-between">
        <button (click)="onAddFeedbackCancel()" [loadingIcon]="'pi pi-times'" [loading]="isLoading" class="flex-auto p-button-outlined"
                icon="pi pi-times" label="Cancelar"
                pButton
                pRipple></button>
        <button (click)="onAddFeedback()" [loading]="isLoading" class="flex-auto" icon="pi pi-save" label="Guardar" pButton pRipple
        ></button>
    </div>
</p-dialog>
